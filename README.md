# Baseball-pitcher-predict

데이터 출처 : https://baseballsavant.mlb.com/leaderboard/custom?year=2022&type=batter&filter=&sort=1&sortDir=desc&min=q&selections=xba,xslg,xwoba,xobp,xiso,exit_velocity_avg,launch_angle_avg,sweet_spot_percent,barrel_batted_rate,&chart=false&x=xba&y=xba&r=no&chartType=beeswarm  


<br />


# 1. 개요
다른 분석 프로젝트나 공부를 하다가 잠시 마음을 돌리고 쉬고싶어 평소 좋아하던 야구에 관해 짧은 예측을 해보기로 하였다.  
메이저리그 투수의 수비 및 운과 무관한 2023시즌의 성적을 예측해 보았다.  



<br />



# 2. 참여 인원 / 기간
* 개인 프로젝트
* 2023년 5월 1일 ~ 2023년 5월 4일


<br />


# 3. 사용 기술
* Python
* SQL
* Matplotlib
* Sklearn
* Pycaret


<br />


# 4. 분석 하고자 하는 대상
* 2023시즌에 메이저리그에서 활동중인 투수들의 성적을 이전 성적들을 바탕으로 예측해보고 싶었다. 이를 위해, 2023년 전에 활약을 했던 선수들 중 현재까지도 현역인 선수들만을 골라 대상으로 하였다
* 분석하고자 하는 성적의 지표는 xwOBA로, 보통 투수의 성적이라 한다면 야구라는 스포츠의 특성상 타구가 맞았을 때 수비수들이 수비를 얼마나 잘하는지, 그 날의 바람 상태나 환경때문에 운이 나쁘게 안타나 홈런이 되었다던지 하는 운과 수비의 요소가 반드시 반영이 된다. xwOBA는 이러한 수비와 운을 완전히 배제한 성적으로, 팀이나 환경에 상관없이 순전히 투수의 능력만을 중립적으로 알 수 있게 해주는 지표이다.
* 이러한 지표가 가능한 이유는 야구에 BABIP이라는 이론이 존재하기 때문인데, 어떤 투수가 던진 공이던 그 공이 타자의 배트에 맞았을 때 일어나는 상황들의 확률은 동등하다는 이론이다.  
메이저리그에서도 매우 뛰어난 성적을 거두는 투수와, 방출 위기에까지 놓인 성적이 좋지 않은 투수의 '공이 배트에 맞았을 때 일어나는 상황들의 확률'이 동일하다는 이 이론은, 처음에는 반발이 심하였지만 통계상 거의 사실인 것으로 드러났다. 따라서, 이 이론을 바탕으로 여러가지 통계 지표가 생겨났고, 이번에 사용하고자 하는 xwOBA도 그렇다.


<br />


<details>
<summary>컬럼 설명</summary>
last_name, first_name, player_id : 선수 이름, id

year : 년도

p_k_percent : 투수의 삼진율

p_bb_percent : 투수의 볼넷율

z_swing_percent : 스트라이크존 안에 던진 공의 스윙 유도율

z_swing_miss_percent : 스트라이크존 안에 던진 공의 헛스윙율

oz_swing_percent : 스트라이크존 밖에 던진 공의 스윙 유도율

oz_swing_miss_percent : 스트라이크존 밖에 던진 공의 헛스윙율

oz_contact_percent : 스트라이크존 밖에서 배트에 맞은 비율

out_zone_percent : 스트라이크존 밖으로 공을 던진 비율

iz_contact_percent : 스트라이크존 안에서 배트에 맞은 비율

in_zone_percent : 스트라이크존 안으로 공을 던진 비율

edge_percent : 스트라이크존 모서리 (보더라인)으로 공을 던진 비율

whiff_percent : 헛스윙 유도율

fastball_avg_speed,fastball_avg_spin,fastball_avg_break : 투수가 던진 직구 계열 투구의 평균 구속, 회전수, 변화정도

breaking_avg_speed,breaking_avg_spin,breaking_avg_break : 투수가 던진 브레이킹볼 (커브, 슬라이더 등)의 평균 구속, 회전수, 변화정도

offspeed_avg_speed,offspeed_avg_spin,offspeed_avg_break : 투수가 던진 오프스피드 피치 (체인지업류)의 평균 구속, 회전수, 변화정도

xwoba : 구하고자 하는 타겟. 수비와 운에 무관하게 기대되는 투수의 성적. 낮을 수록 성적이 좋음
  

</details>

<br />



# 5. 분석 방법
* 야구는 다른 스포츠보다도 매년 마다 성적을 예측하기 힘든 스포츠라고 생각한다. 작년까지만 해도 엄청난 에이스였던 선수가 갑자기 구속이 떨어져서 무너지는 모습은 야구에선 드물지 않은 일이다. 그러나 통계에서 예측을 할 경우에는, 저런 예외적인 상황들을 제외하고 통상적인 상황들을 예측해야 한다고 생각한다. 
* 따라서, 2023시즌 이전의 최근 3년간의 성적을 통해 예측을 할 예정이고, 가장 최근의 성적에 더 많은 가중치를 두어 학습하고자 한다.
* 2016~2022시즌 까지의 선수들의 기록들을 바탕으로 성적을 예측하는 모델을 학습 시킨 뒤 (train),  
2023 시즌의 실제 기록을 통하여 구한 예측 성적과 실제 성적을 비교하여 모델이 적합한지를 평가하고 (Valid),  
2023 시즌의 선수들의 기록을 이전 시즌의 성적들로 예측하여 이 예측한 기록들을 모델에 대입하여 예상 성적을 구한다. (Test)
* 이렇게 해서 예측한 성적보다 매우 좋게 나왔거나, 매우 안좋게 나온 경우에 대해서 원인을 파악해볼 예정이다.



<br />


# 6. 진행 과정


<br />


## 1. 전처리
* 이번 데이터는 데이터를 얻는 과정에서 이미 내가 필요하다고 판단한 피쳐들만 가져와 주었기에, 불필요한 컬럼은 없었다. 
* 또한, 이번 데이터에서 모든 변수들은 정규분포와 가까운 분포를 이루고 있었기에, 이상치 제거나 분포 변환이 필요가 없었다.
* 하지만, 일부 투수들이 던지지 않는 구종에 대해서는 결측치들이 존재하므로, 그 구종을 던지는지 여부에 따른 라벨 인코딩을 적용한 컬럼을 생성하였고, 결측치 값을 대신 0으로 대체하였다.
* 또한, SQL을 활용하여 2023시즌 이전에 3시즌 이상 뛴 투수들을 조회하고, 이 투수들중 2023시즌에도 뛰는 선수들의 리스트만을 받아온 뒤, 최근 성적일 수록 가중치를 부여하여 2023시즌의 예상 기록 데이터를 생성하였다. 이를 바탕으로 최종 모델에 Test를 할 예정이다.


<br />


## 2. EDA
* 먼저 연속형 변수들의 분포부터 살펴보았는데, 결측치 처리로 인하여 분포가 바뀐 컬럼들을 제외하고는 전부 정규분포에 가까운 분포를 보인다.
* 연속형 변수들과 타켓간의 상관관계를 살펴보았고, 거의 모든 컬럼과 상관관계가 있었다.
* 특히나, 투수가 던진 공의 구속, 변화 정도, 회전수에 따른 성적간의 관계를 그래프로 그려보니 확연하게 차이나는 것을 확인 할 수 있었다.
* 또한, 필요하다고 생각하여 컬럼 하나를 더 추가하였는데, 직구와 오프스피드 피치 간의 구속 차이도 중요한 요소라고 생각하여 추가하였다.


* EDA.ipynb 참조


<br />


## 3. 모델링
* 이번 데이터는 크기가 매우 작았기에, AutoML (Pycaret) 을 통하여 간편하게 성능이 좋은 모델을 얻고자 하였다.
* 평소에는 데이터의 크기가 커서 거의 사용을 하지 못했지만, 사용하고나니 확실히 편리하다는 생각이 들었다.
* mse기준 가장 성능이 좋은 모델 5가지를 선정한 뒤, 이 5가지 모델들을 각각 그리드 서치를 하고 마지막으로 앙상블을 통하여 최종 모델을 만들었다.


<br />


## 4. 예측
* 최종 모델을 통하여 validation용 데이터와 test용 데이터를 예측 하였는데, 두 데이터에서 나온 예측치와 실제값으로 MSE를 구해보니, 큰 차이가 없었다.
* 즉, 이전까지의 기록을 토대로 예상한 기록 데이터로, 2023시즌의 성적을 예측하는데 성공하였다는 뜻이다.


<br />


# 5. 회고 및 느낀점
* 평소에 가장 흥미 있어하고 재미를 느끼던 야구의 데이터를 분석하는 것이, 굉장히 즐거웠다.
* 다만, 나중에 plotly와 dash를 이용한 시각화를 진행하던 중에, 이때 당시는 확인하지 못했던 이상치들이 발견되어 좀 더 이상치 탐색을 열심히 했었어야 한다고 생각한다.
* 위에서 언급한 이상치들을 놓쳤던 이유는, 보통의 이상치처럼 일정 범위에서 벗어난 값이 아니기 때문이다. 평소 야구를 자주 봐왔기에 이상치라고 판단할 수 있었는데, 브레이킹볼의 특성상 회전수는 아무리 적어도 1600은 나와야 정상인데 1100정도에 머무르는 투수들이 있었고, 직접 이 투수의 해당 년도 투구 데이터를 찾아서 보니 브레이킹볼이 아닌데 브레이킹볼로 기입을 한 기입 오류였다.
* 위에서 느낀점은, 데이터를 다루는데 있어서 기계적으로 해서는 안된다는 것이다. 평소 하던 것처럼 정상 범위 내에 있다고 이상치가 아니라고 판단하는 것이 아닌, 그 데이터가 무엇을 뜻하는지 완벽하게 파악한 후에 이상치인지 더 철저하게 검증해야 한다는 것이다.
